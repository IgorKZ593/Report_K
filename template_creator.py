# template_creator.py
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Excel-—à–∞–±–ª–æ–Ω–∞ –æ—Ç—á–µ—Ç–∞ —Å –ª–∏—Å—Ç–æ–º ¬´–ø–æ—Ä—Ç—Ñ–µ–ª—å¬ª.
–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —Å –∏–º–µ–Ω–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º –¥–∞—Ç, –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON-—Ñ–∞–π–ª–æ–≤ (–∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –¥–∞—Ç—ã –æ—Ç—á–µ—Ç–∞)
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è
- –°–æ–∑–¥–∞–Ω–∏–µ Excel-—à–∞–±–ª–æ–Ω–∞ —Å –¥–≤—É–º—è –ª–∏—Å—Ç–∞–º–∏
"""

# ===============================
# –ò–º–ø–æ—Ä—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
# ===============================
import os          # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏ –ø—É—Ç—è–º–∏
import sys         # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ sys.executable (–ø—É—Ç—å –∫ Python)
import json        # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON-—Ñ–∞–π–ª–∞–º–∏
import shutil      # –î–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ)
from pathlib import Path  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ os.path)

# ===============================
# üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ rich
# ===============================
try:
    from rich import print
    from rich.console import Console
except ImportError:
    # –ï—Å–ª–∏ rich –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    print("üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É rich...")
    os.system(f'"{sys.executable}" -m pip install rich')
    from rich import print
    from rich.console import Console

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
console = Console()

# ===============================
# üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ xlwings
# ===============================
try:
    import xlwings as xw
except ImportError:
    # –ï—Å–ª–∏ xlwings –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    console.print("üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É xlwings...", style="bold green")
    os.system(f'"{sys.executable}" -m pip install xlwings')
    import xlwings as xw


def load_json_data(path: str) -> dict:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Ñ–∞–π–ª–∞ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏.
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        path (str): –ü—É—Ç—å –∫ JSON-—Ñ–∞–π–ª—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ JSON-—Ñ–∞–π–ª–∞
        
    –ò—Å–∫–ª—é—á–µ–Ω–∏—è:
        FileNotFoundError: –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø—É—Ç–∏
        json.JSONDecodeError: –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON
        
    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        name_data = load_json_data("Data_work/name_clients.json")
    """
    try:
        with open(path, 'r', encoding='utf-8') as file:
            return json.load(file)
    except FileNotFoundError:
        raise FileNotFoundError(f"–§–∞–π–ª {path} –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except json.JSONDecodeError as e:
        raise json.JSONDecodeError(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON –≤ —Ñ–∞–π–ª–µ {path}: {e}")


def get_output_filename(name_data: dict, date_data: dict) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ Excel –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ø–æ—Ä—Ç—Ñ–µ–ª—å_–§–∞–º–∏–ª–∏—è –ò. –û._–¥–∞—Ç–∞_–¥–∞—Ç–∞.xlsx
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        name_data (dict): –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞, –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á "client_name"
        date_data (dict): –°–ª–æ–≤–∞—Ä—å —Å –¥–∞—Ç–∞–º–∏, –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–∏ "start_date" –∏ "end_date"
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –ò–º—è —Ñ–∞–π–ª–∞ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        
    –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
        1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ name_data
        2. –†–∞–∑–¥–µ–ª—è–µ—Ç –ø–æ–ª–Ω–æ–µ –∏–º—è –Ω–∞ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª—ã
        3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–∑ date_data
        4. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –ø–æ —à–∞–±–ª–æ–Ω—É
        
    –ü—Ä–∏–º–µ—Ä:
        name_data = {"client_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤–∏—á"}
        date_data = {"start_date": "01.01.2024", "end_date": "31.01.2024"}
        –†–µ–∑—É–ª—å—Ç–∞—Ç: "–ø–æ—Ä—Ç—Ñ–µ–ª—å_–ò–≤–∞–Ω–æ–≤ –ò. –ü._01.01.2024_31.01.2024.xlsx"
    """
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
    client_name = name_data.get("client_name", "").strip()
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è –Ω–∞ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª—ã
    if client_name:
        parts = client_name.split(" ", 1)  # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ø–µ—Ä–≤–æ–º—É –ø—Ä–æ–±–µ–ª—É
        surname = parts[0] if len(parts) > 0 else ""      # –§–∞–º–∏–ª–∏—è - –ø–µ—Ä–≤–∞—è —á–∞—Å—Ç—å
        initials = parts[1] if len(parts) > 1 else ""     # –ò–Ω–∏—Ü–∏–∞–ª—ã - –≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å
    else:
        surname = ""
        initials = ""

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—ã –∏–∑ —Å–ª–æ–≤–∞—Ä—è
    start_date = date_data.get('start_date', '')
    end_date = date_data.get('end_date', '')

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è –∏ –∏–º—è —Ñ–∞–π–ª–∞
    full_name = f"{surname} {initials}".strip()
    filename = f"–ø–æ—Ä—Ç—Ñ–µ–ª—å_{full_name}_{start_date}_{end_date}.xlsx"

    return filename


def archive_existing_portfolio_files(folder: str, backup_folder: str) -> list[str]:
    """
    –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤ –ø–∞–ø–∫—É —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π.
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        folder (str): –ü–∞–ø–∫–∞, –≥–¥–µ –∏—Å–∫–∞—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        backup_folder (str): –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        list[str]: –°–ø–∏—Å–æ–∫ –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ—â–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        
    –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
        1. –°–æ–∑–¥–∞–µ—Ç –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        2. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–∞–ø–∫–µ
        3. –ù–∞—Ö–æ–¥–∏—Ç —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "–ø–æ—Ä—Ç—Ñ–µ–ª—å" –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞ ".xlsx"
        4. –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        5. –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
        6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ—â–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        
    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        moved_files = archive_existing_portfolio_files("Data_work", "Data_Backup")
    """
    moved_files = []
    
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    os.makedirs(backup_folder, exist_ok=True)

    # –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –ø–∞–ø–∫–µ
    for filename in os.listdir(folder):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —Ñ–∞–π–ª –ø–æ–¥ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        if filename.startswith("–ø–æ—Ä—Ç—Ñ–µ–ª—å") and filename.endswith(".xlsx"):
            source_path = os.path.join(folder, filename)
            dest_path = os.path.join(backup_folder, filename)
            
            try:
                # –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
                shutil.move(source_path, dest_path)
                moved_files.append(filename)
                console.print(f"üì¶ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª [white]{filename}[/] ‚Üí –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ [bold]Data_Backup[/]")
            except Exception as e:
                console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {filename}:[/] {e}")

    return moved_files


def create_excel_template(output_path: str, filename: str):
    """
    –°–æ–∑–¥–∞–µ—Ç Excel-—Ñ–∞–π–ª —Å –¥–≤—É–º—è –ª–∏—Å—Ç–∞–º–∏: "–ø–æ—Ä—Ç—Ñ–µ–ª—å" –∏ "stock_etf_price".
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        output_path (str): –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–º—É Excel-—Ñ–∞–π–ª—É
        filename (str): –ò–º—è —Ñ–∞–π–ª–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
        
    –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
        1. –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Excel —á–µ—Ä–µ–∑ xlwings
        2. –°–æ–∑–¥–∞–µ—Ç –ª–∏—Å—Ç "–ø–æ—Ä—Ç—Ñ–µ–ª—å" —Å –∫–æ—Ä–∏—á–Ω–µ–≤–æ–π –≤–∫–ª–∞–¥–∫–æ–π
        3. –î–æ–±–∞–≤–ª—è–µ—Ç –ª–∏—Å—Ç "stock_etf_price" —Å —Å–∏–Ω–µ–π –≤–∫–ª–∞–¥–∫–æ–π
        4. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤
        6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç Excel
        
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
        - –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ—Ä–Ω—É—Ç—ã –≤ try-except
        - –ü—Ä–∏ –æ—à–∏–±–∫–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç Excel –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã
        
    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        create_excel_template("Data_work/portfolio.xlsx", "portfolio.xlsx")
    """
    app = None
    try:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Excel (–Ω–µ–≤–∏–¥–∏–º—ã–π)
        app = xw.App(visible=False)
        wb = app.books.add()

        # ===============================
        # –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ "–ø–æ—Ä—Ç—Ñ–µ–ª—å"
        # ===============================
        sheet = wb.sheets[0]  # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
        sheet.name = "–ø–æ—Ä—Ç—Ñ–µ–ª—å"  # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –µ–≥–æ
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤–∫–ª–∞–¥–∫–∏ (–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π)
        try:
            sheet.api.Tab.ColorIndex = 53  # –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π —Ü–≤–µ—Ç
        except:
            pass  # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É

        # ===============================
        # –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ "stock_etf_price"
        # ===============================
        stock_sheet = wb.sheets.add("stock_etf_price")  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤–∫–ª–∞–¥–∫–∏ (—Å–∏–Ω–∏–π)
        try:
            stock_sheet.api.Tab.ColorIndex = 5  # –°–∏–Ω–∏–π —Ü–≤–µ—Ç
        except:
            pass

        # ===============================
        # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
        # ===============================
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ stock_etf_price
        headers = ["ISIN", "–¢–∏–∫–µ—Ä", "–ù–∞–∑–≤–∞–Ω–∏–µ", "start_date", "start_price", "end_date", "end_price", "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ"]
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        for col, header in enumerate(headers, 1):
            cell = stock_sheet.range((1, col))  # –ü–æ–ª—É—á–∞–µ–º —è—á–µ–π–∫—É –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ
            cell.value = header  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            try:
                cell.api.Font.Bold = True  # –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç
                cell.api.HorizontalAlignment = -4108  # xlCenter - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
                cell.api.VerticalAlignment = -4108    # xlCenter - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
            except:
                pass  # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–µ—Ç—Å—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º

        # ===============================
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
        # ===============================
        try:
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (A-H)
            stock_sheet.api.Columns("A:H").ColumnWidth = 12
        except:
            pass

        # ===============================
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ
        # ===============================
        wb.save(output_path)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        wb.close()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–Ω–∏–≥—É
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º Excel
        if app:
            app.quit()

    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞
        console.print(f"[red]–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel-—Ñ–∞–π–ª–∞:[/] {e}")
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º Excel –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if app:
            try:
                app.quit()
            except:
                pass
        raise  # –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ


def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞.
    
    –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
        1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Ñ–∞–π–ª–æ–≤
        2. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        3. –ê—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Ä—Ç—Ñ–µ–ª—è
        4. –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π Excel-—à–∞–±–ª–æ–Ω
        5. –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
        
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
        - FileNotFoundError: –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã JSON-—Ñ–∞–π–ª—ã
        - json.JSONDecodeError: –ï—Å–ª–∏ JSON-—Ñ–∞–π–ª—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã
        - Exception: –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
        
    –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º:
        - name_clients.json: —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
        - report_dates.json: —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç—ã –æ—Ç—á–µ—Ç–∞
        - –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ Data_work
        - –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Data_Backup
    """
    # ===============================
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
    # ===============================
    data_work_path = r"F:\Python Projets\Report\Data_work"      # –ü–∞–ø–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    data_backup_path = r"F:\Python Projets\Report\Data_Backup"  # –ü–∞–ø–∫–∞ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏ –∫ JSON-—Ñ–∞–π–ª–∞–º
    name_clients_path = os.path.join(data_work_path, "name_clients.json")
    report_dates_path = os.path.join(data_work_path, "report_dates.json")

    try:
        # ===============================
        # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Ñ–∞–π–ª–æ–≤
        # ===============================
        console.print(f"[bold cyan]üìÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Ñ–∞–π–ª–æ–≤...[/]")
        name_data = load_json_data(name_clients_path)  # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
        date_data = load_json_data(report_dates_path)  # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç

        # ===============================
        # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        # ===============================
        filename = get_output_filename(name_data, date_data)  # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞
        output_path = os.path.join(data_work_path, filename)  # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å

        console.print(f"[green]üìÅ –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª:[/] [white]{filename}[/]")

        # ===============================
        # 3. –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Ä—Ç—Ñ–µ–ª—è
        # ===============================
        console.print("[yellow]üì¶ –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è...[/]")
        moved_files = archive_existing_portfolio_files(data_work_path, data_backup_path)

        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        if moved_files:
            console.print(f"[magenta]üîÅ –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:[/] {len(moved_files)}")
        else:
            console.print("[grey]‚è≥ –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã[/]")

        # ===============================
        # 4. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π Excel-—à–∞–±–ª–æ–Ω
        # ===============================
        console.print("[blue]üõ† –°–æ–∑–¥–∞—é Excel-—à–∞–±–ª–æ–Ω...[/]")
        create_excel_template(output_path, filename)

        # ===============================
        # 5. –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏
        # ===============================
        console.print(f"[bold green]‚úîÔ∏è –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ –æ—Ç—á–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω:[/] [white]{filename}[/]")
        console.print(f"[white]üìç –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:[/] [bold cyan]{output_path}[/]")

    except FileNotFoundError as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏: —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞: {e}[/]")
        console.print(
            "[yellow]‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã name_clients.json –∏ report_dates.json —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ Data_work[/]")
    except json.JSONDecodeError as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏: –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π JSON
        console.print(f"[red]‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: {e}[/]")
        console.print("[yellow]‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å JSON-—Ñ–∞–π–ª–æ–≤[/]")
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
        console.print(f"[bold red]üí• –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:[/] {e}")


# ===============================
# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É
# ===============================
if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
    # (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –º–æ–¥—É–ª—å)
    main()
